Feature: Gamification

  Scenario: Voir le points au lancement de l'application
    Given I am logged in
    Given the API will return
      | 'method' | 'path'                                | 'statusCode' | 'responseData'  |
      | 'GET'    | '/utilisateurs/{userId}/gamification' |          200 | {"points":2000} |
    Given The application is launched
    Then I see {'2000'} points
    Then I don't see {'0'} badges

  Scenario: Voir le popup de reset si c'est un ancien compte
    Given I am logged in
    Given the API will return
      | 'method' | 'path'                                                | 'statusCode' | 'responseData'                                                                                           |
      | 'GET'    | '/utilisateurs/{userId}'                              |          200 | {"pseudo":"Lucas","is_onboarding_done":true,"popup_reset_est_vue":false,"is_nom_prenom_modifiable":true} |
      | "POST"   | "/utilisateurs/{userId}/gamification/popup_reset_vue" |          200 | {}                                                                                                       |
      | 'GET'    | '/utilisateurs/{userId}/gamification'                 |          200 | {"points":2000}                                                                                          |
    Given The application is launched
    Then I see {'Il y a du nouveau sur J’agis !'}
    When I tap on {'Continuer'}
    Then I see {'Merci pour votre soutien !'}
    Given the API will return
      | 'method' | 'path'                                | 'statusCode' | 'responseData'                                                                                                                                       |
      | 'GET'    | '/utilisateurs/{userId}/gamification' |          200 | {"points":200,"badges":[{"description":"Présent depuis les premiers jours","image_url":"badge-pionnier.webp","titre":"Pionnier","type":"pionnier"}]} |
    When I tap on {'Récolter'}
    Then I see {'200'} points
    Then I see {'1'} badges
    Then I don't see {'Merci pour votre soutien !'}
    Then the API receives
      | 'method' | 'path'                                                | 'statusCode' | 'requestData' |
      | "POST"   | "/utilisateurs/{userId}/gamification/popup_reset_vue" |          200 | null          |

  Scenario: Répondre pour la 1ere fois à la personnalisation d'une thématique fait gagner 25 points
    Given I am logged in
    Given the API will return
      | 'method' | 'path'                                                                                                            | 'statusCode' | 'responseData'                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
      | 'GET'    | '/utilisateurs/{userId}/gamification'                                                                             |          200 | {"points":0}                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
      | 'GET'    | '/utilisateurs/{userId}/enchainementQuestionsKYC_v2/ENCHAINEMENT_KYC_personnalisation_transport/first'            |          200 | {"nombre_total_questions":3,"nombre_total_questions_effectives":3,"position_courante":2,"question_courante":{"code":"KYC003","question":"Êtes-vous équipé(e) d’un vélo ?","reponse_multiple":[{"code":"oui","label":"Oui","selected":false},{"code":"non","label":"Non","selected":false}],"is_answered":false,"categorie":"mission","points":5,"type":"choix_unique","is_NGC":false,"thematique":"transport"},"is_first":false,"is_last":false,"is_out_of_range":false} |
      | 'GET'    | '/utilisateurs/{userId}/questionsKYC_v2/KYC003'                                                                   |          200 | {"code":"KYC003","question":"Êtes-vous équipé(e) d’un vélo ?","reponse_multiple":[{"code":"oui","label":"Oui","selected":false},{"code":"non","label":"Non","selected":false}],"is_answered":false,"categorie":"mission","points":5,"type":"choix_unique","is_NGC":false,"thematique":"transport"}                                                                                                                                                                       |
      | 'PUT'    | '/utilisateurs/{userId}/questionsKYC_v2/KYC003'                                                                   |          200 | {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
      | 'GET'    | '/utilisateurs/{userId}/enchainementQuestionsKYC_v2/ENCHAINEMENT_KYC_personnalisation_transport/following/KYC003' |          200 | {"nombre_total_questions":3,"nombre_total_questions_effectives":3,"position_courante":-1,"is_first":false,"is_last":false,"is_out_of_range":false}                                                                                                                                                                                                                                                                                                                       |
    Given The application is launched
    When I tap on {1} text {'🚅 Me déplacer'}
    When I scroll down to {'Commencer'}
    Then I see {'0'} points
    When I tap on {'Commencer'}
    When I tap on {'Oui'}
    Given the API will return
      | 'method' | 'path'                                | 'statusCode' | 'responseData' |
      | 'GET'    | '/utilisateurs/{userId}/gamification' |          200 | {"points":25}  |
    When I tap on {'Question suivante'}
    Then I see {'25'} points

  Scenario: Répondre a un quiz fait gagner 20 des feuilles
    Given I am logged in
    Given the API will return
      | 'method' | 'path'                                | 'statusCode' | 'responseData' |
      | 'GET'    | '/utilisateurs/{userId}/gamification' |          200 | {"points":1}   |
    Given The application is launched
    When I tap on the menu button
    Given I have actions in my library
      | 'type'  | 'code'             | 'title'                  | 'nb_aids_available' |
      | 'quizz' | 'quiz_tri_dechets' | 'Bien trier les déchets' |                   5 |
    Given the API will return
      | 'method' | 'path'                                                        | 'statusCode' | 'responseData'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
      | "PATCH"  | "/utilisateurs/{userId}/bibliotheque/quizz/123"               |          200 | {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
      | "PATCH"  | "/utilisateurs/{userId}/bibliotheque/quizz/216"               |          200 | {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
      | "GET"    | "/utilisateurs/{userId}/actions/quizz/quiz_tri_dechets"       |          200 | {"nombre_actions_en_cours":5,"nombre_actions_faites":5,"nombre_aides_disponibles":0,"code":"quiz_tri_dechets","titre":"Bien trier les déchets","sous_titre":"Testez vos connaissances sur le tri des déchets avec ce quiz !","consigne":"Réalisez cette action dans les prochaines semaines et partagez vos retours","label_compteur":"**453 actions** réalisées par la communauté","besoins":[],"comment":null,"pourquoi":null,"type":"quizz","thematique":"consommation","kycs":[],"quizzes":[{"content_id":"123","article_contenu":"<h2>Les idées reçues sur le compost</h2><h3>Tous les déchets organiques peuvent être compostés - Faux</h3><p>Certains déchets comme la viande, le poisson, les produits laitiers et les huiles ne conviennent pas au compostage classique car ils attirent les nuisibles et ralentissent le processus. En revanche, les déchets de cuisine comme les épluchures de fruits et légumes, le marc de café, et les coquilles d'œufs sont parfaits pour le compost​.</p><h3>Le compostage sent mauvais - Faux</h3><p>Bien géré, le compost ne dégage pas d'odeurs désagréables. Un bon équilibre entre matières vertes (azote) et brunes (carbone), ainsi qu'une aération régulière, prévient les mauvaises odeurs​​.</p><h3>Le compostage nécessite beaucoup d'entretien - Faux</h3><p>Le compostage demande un entretien modéré, comme ajouter les bons matériaux et aérer le tas. Une gestion basique suffit souvent pour produire du compost de qualité sans trop d'efforts.</p><h3>Le compost attire les animaux - Vrai et Faux</h3><p>Le compost peut attirer des animaux si des déchets comme la viande et les produits laitiers y sont ajoutés. En ne compostant que des matières appropriées et en utilisant des bacs fermés, vous pouvez minimiser ce risque.</p><h3>Le compostage est lent et inefficace - Faux</h3><p>Le compostage peut produire du compost en quelques mois avec les bonnes conditions de chaleur, d'humidité, et d'aération. Des méthodes comme le compostage en bac rotatif peuvent accélérer le processus.</p>","article_sources":[{"url":"https://reseaucompost.org/sites/default/files/2024-03/Fiche%20technique%20n%C2%B012%20V2%284%29.pdf","label":"Réseau Compost"}],"article_id":"160","difficulty":2,"duree":"⏱️ 2 minutes","points":5,"sousTitre":null,"titre":"Vrai ou faux : tous les déchets organiques peuvent être compostés","thematique_principale":"dechet","questions":[{"explicationKO":null,"explicationOk":null,"libelle":"Vrai ou faux : tous les déchets organiques peuvent être compostés","reponses":[{"exact":false,"reponse":"Vrai"},{"exact":true,"reponse":"Faux"}]}]},{"content_id":"216","article_id":null,"difficulty":1,"duree":"⏱️ 2 minutes","points":5,"sousTitre":null,"titre":"Où jeter une barquette en aluminium ?","thematique_principale":"alimentation","questions":[{"explicationKO":"<p><strong>L'aluminium se recycle. </strong>La barquette, préalablement vidée et lavée, doit donc être placée dans la <strong>poubelle des emballages recyclables</strong>. </p><blockquote><p>ℹ️ <strong><em>Le saviez-vous ? </em></strong>On estime que 75% de l'aluminium produit depuis 1880 est toujours utilisé aujourd'hui.</p></blockquote>","explicationOk":"<p><strong>L'aluminium se recycle. </strong>La barquette, préalablement vidée et lavée, doit donc être placée dans la <strong>poubelle des emballages recyclables</strong>. </p><blockquote><p>ℹ️ <strong><em>Le saviez-vous ? </em></strong>On estime que 75% de l'aluminium produit depuis 1880 est toujours utilisé aujourd'hui.</p></blockquote>","libelle":"Où jeter une barquette en aluminium ?","reponses":[{"exact":false,"reponse":"Avec les ordures ménagères, l'aluminium ne se recycle pas"},{"exact":true,"reponse":"Poubelle jaune, l'aluminium se recycle"},{"exact":false,"reponse":"Conteneur à verre, il sera trié par la suite"}]}]}],"aides":[],"services":[],"nom_commune":"Asnières-sur-Seine","quizz_felicitations":"Alors, le tri n'a plus de secret pour vous ? En cas de doute, rendez-vous sur le site Que faire de mes déchets","deja_vue":true,"deja_faite":true,"faqs":[],"points":20,"explications_recommandation":{"liste_explications":[],"est_exclu":false},"explications_recommandation_raw":{"liste_explications":[]}} |
      | "GET"    | "/utilisateurs/{userId}/actions/quizz/quiz_tri_dechets/score" |          200 | {"nombre_bonnes_reponses":2,"nombre_quizz_done":2}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
      | "POST"   | "/utilisateurs/{userId}/actions/quizz/quiz_tri_dechets/faite" |          200 | {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
    When I tap on {'Actions'}
    When I tap on {'Bien trier les déchets'}
    When I tap on {'Faux'}
    When I scroll down to {'Voir la réponse'}
    When I tap on {'Voir la réponse'}
    When I scroll down to {'Question suivante'}
    When I tap on {'Question suivante'}
    When I scroll down to {"Poubelle jaune, l'aluminium se recycle"}
    When I tap on {"Poubelle jaune, l'aluminium se recycle"}
    When I scroll down to {'Voir la réponse'}
    When I tap on {'Voir la réponse'}
    When I scroll down to {'Voir le résultat'}
    Then I see {'1'} points
    Given the API will return
      | 'method' | 'path'                                | 'statusCode' | 'responseData' |
      | 'GET'    | '/utilisateurs/{userId}/gamification' |          200 | {"points":21}  |
    When I tap on {'Voir le résultat'}
    Then I see {'21'} points

  Scenario: Répondre a un bilan fait gagner 50 des feuilles
    Given I have actions in my library
      | 'type'  | 'code'                      | 'title'                                              | 'nb_aids_available' |
      | 'bilan' | 'action_bilan_alimentation' | 'Calculer les impacts liés à **votre alimentation**' |                   2 |
    Given the API will return
      | 'method' | 'path'                                | 'statusCode' | 'responseData' |
      | 'GET'    | '/utilisateurs/{userId}/gamification' |          200 | {"points":1}   |
    Given I am logged in
    Given The application is launched
    When I tap on the menu button
    Given the API will return
      | 'method' | 'path'                                                                                                             | 'statusCode' | 'responseData'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
      | 'GET'    | '/utilisateurs/{userId}/actions/bilan/action_bilan_alimentation'                                                   |          200 | {"nombre_actions_en_cours":0,"nombre_actions_faites":0,"nombre_aides_disponibles":0,"code":"action_bilan_alimentation","titre":"Calculer les impacts liés à **votre alimentation**","sous_titre":"Quelques questions pour mieux comprendre vos habitudes et calculer le bilan carbone de votre alimentation","consigne":"Réalisez cette action dans les prochaines semaines et partagez vos retours","label_compteur":"**453 actions** réalisées par la communauté","besoins":[],"comment":null,"pourquoi":null,"type":"bilan","thematique":"alimentation","quizzes":[],"aides":[],"services":[],"nom_commune":"Bordeaux","quizz_felicitations":null,"deja_vue":false,"deja_faite":false,"faqs":[],"points":50,"sources":[],"articles":[],"like_level":null,"explications_recommandation":{"liste_explications":[],"est_exclu":false},"explications_recommandation_raw":{"liste_explications":[]},"enchainement_id":"bilan_action_bilan_alimentation"} |
      | 'GET'    | '/utilisateurs/{userId}/enchainementQuestionsKYC_v2/bilan_action_bilan_alimentation/first'                         |          200 | {"nombre_total_questions_effectives":2,"position_courante":1,"question_courante":{"code":"KYC_petitdej","question":"Quel petit déjeuner vous correspond le plus ?","reponse_multiple":[{"code":"pain","label":" Viennoiserie et pain","selected":false},{"code":"lait","label":"Lait et céréales","selected":false},{"code":"bacon","label":"Salé (type britannique, bacon et oeuf)","selected":false},{"code":"fruit","label":"Fruits","selected":false},{"code":"aucun","label":"Pas de petit-dej'","selected":false}],"is_answered":false,"categorie":"mission","points":5,"type":"choix_unique","is_NGC":true,"thematique":"alimentation"},"is_first":false,"is_last":false,"is_out_of_range":false}                                                                                                                                                                                                                                               |
      | 'GET'    | '/utilisateurs/{userId}/questionsKYC_v2/KYC_petitdej'                                                              |          200 | {"code":"KYC_petitdej","question":"Quel petit déjeuner vous correspond le plus ?","reponse_multiple":[{"code":"pain","label":" Viennoiserie et pain","selected":false},{"code":"lait","label":"Lait et céréales","selected":false},{"code":"bacon","label":"Salé (type britannique, bacon et oeuf)","selected":false},{"code":"fruit","label":"Fruits","selected":false},{"code":"aucun","label":"Pas de petit-dej'","selected":false}],"is_answered":false,"categorie":"mission","points":5,"type":"choix_unique","is_NGC":true,"thematique":"alimentation"}                                                                                                                                                                                                                                                                                                                                                                                          |
      | "PUT"    | "/utilisateurs/{userId}/questionsKYC_v2/KYC_petitdej"                                                              |          200 | {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
      | "GET"    | '/utilisateurs/{userId}/enchainementQuestionsKYC_v2/bilan_action_bilan_alimentation/following/KYC_petitdej'        |          200 | {"nombre_total_questions_effectives":2,"position_courante":2,"question_courante":{"code":"KYC_local_frequence","question":"À quelle fréquence consommez-vous des produits locaux ?","reponse_multiple":[{"code":"jamais","label":"Jamais","selected":true},{"code":"parfois","label":"Parfois","selected":false},{"code":"souvent","label":"Souvent","selected":false},{"code":"toujours","label":"Toujours","selected":false}],"is_answered":true,"categorie":"mission","points":5,"type":"choix_unique","is_NGC":true,"thematique":"alimentation"},"is_first":false,"is_last":false,"is_out_of_range":false}                                                                                                                                                                                                                                                                                                                                         |
      | 'GET'    | '/utilisateurs/{userId}/questionsKYC_v2/KYC_local_frequence'                                                       |          200 | {"code":"KYC_local_frequence","question":"À quelle fréquence consommez-vous des produits locaux ?","reponse_multiple":[{"code":"jamais","label":"Jamais","selected":true},{"code":"parfois","label":"Parfois","selected":false},{"code":"souvent","label":"Souvent","selected":false},{"code":"toujours","label":"Toujours","selected":false}],"is_answered":true,"categorie":"mission","points":5,"type":"choix_unique","is_NGC":true,"thematique":"alimentation"}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
      | "PUT"    | "/utilisateurs/{userId}/questionsKYC_v2/KYC_local_frequence"                                                       |          200 | {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
      | "GET"    | '/utilisateurs/{userId}/enchainementQuestionsKYC_v2/bilan_action_bilan_alimentation/following/KYC_local_frequence' |          200 | {"nombre_total_questions_effectives":2,"position_courante":-1,"is_first":false,"is_last":false,"is_out_of_range":false}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
      | "GET"    | "/utilisateurs/{userId}/bilans/last_v3/alimentation"                                                               |          200 | {"thematique":"alimentation","impact_kg_annee":3873.1151821000003,"details":[{"label":"Viandes","impact_kg_annee":2233.296,"emoji":"🥩"},{"label":"Boissons","impact_kg_annee":940.1798000000001,"emoji":"🥤"},{"label":"Poissons","impact_kg_annee":182,"emoji":"🐟"},{"label":"Petit déjeuner","impact_kg_annee":113.15,"emoji":"🥐"},{"label":"Fruits & Légumes","impact_kg_annee":0,"emoji":"🥦"}],"emoji":"🍴"}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
      | "POST"   | "/utilisateurs/{userId}/actions/bilan/action_bilan_alimentation/faite"                                             |          200 | {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
    When I tap on {'Actions'}
    When I tap on {'Calculer les impacts liés à votre alimentation'}
    When I tap on {'Viennoiserie et pain'}
    When I scroll down to {'Question suivante'}
    When I tap on {'Question suivante'}
    When I tap on {'Jamais'}
    When I scroll down to {'Question suivante'}
    Then I see {'1'} points
    Given the API will return
      | 'method' | 'path'                                | 'statusCode' | 'responseData' |
      | 'GET'    | '/utilisateurs/{userId}/gamification' |          200 | {"points":51}  |
    When I tap on {'Question suivante'}
    Then I see {'51'} points
